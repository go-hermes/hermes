<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <style type="text/css" rel="stylesheet" media="all">
            {{/* Render CSS from map[string]map[string]interface{} */}}
            {{ $css := .Email.Body.TemplateOverrides.css }}
            {{ if $css }}
                {{ range $selector, $props := $css }}
                    {{ $selector }} {
                        {{ range $key, $val := $props }}
                            {{ $key }}: {{ css $val }};
                        {{ end }}
                    }
                {{ end }}
            {{ else }}
                /* No CSS provided - using defaults from Go code */
            {{ end }}

            {{/* At-rules (e.g., @font-face, @keyframes) */}}
            {{ if and (not (kindIs "invalid" .Email.Body.TemplateOverrides)) (hasKey .Email.Body.TemplateOverrides "at_rules") }}
                {{ $ats := index .Email.Body.TemplateOverrides "at_rules" }}
                {{ if $ats }}
                    {{ range $rule := $ats }}
                        {{ css $rule }}
                    {{ end }}
                {{ end }}
            {{ end }}

            /* Media Queries */
            @media only screen and (max-width: {{ if or (kindIs "invalid" .Email.Body.TemplateOverrides) (not (hasKey .Email.Body.TemplateOverrides "body_width")) (eq (index .Email.Body.TemplateOverrides "body_width") "") }}600px{{ else }}{{index .Email.Body.TemplateOverrides "body_width"}}{{ end }}) {
                .email-body_inner,
                .email-footer {
                    width: 100% !important;
                }
            }

            @media only screen and (max-width: 500px) {
                .button {
                    width: 100% !important;
                }
            }

            {{ if and (not (kindIs "invalid" .Email.Body.TemplateOverrides)) (hasKey .Email.Body.TemplateOverrides "additional_styles") (not (eq (index .Email.Body.TemplateOverrides "additional_styles") "")) }} {{ index .Email.Body.TemplateOverrides "additional_styles" | css }} {{ end }}
        </style>
    </head>

    <body class="theme-{{ $.Hermes.Theme.Name }}" dir="{{.Hermes.TextDirection}}">
        <table class="email-wrapper" width="100%" cellpadding="0" cellspacing="0">
            <tr>
                <td class="content">
                    <table class="email-content" width="100%" cellpadding="0" cellspacing="0">
                        <!-- Logo -->
                        <tr>
                            <td class="email-masthead">
                                <a class="email-masthead_name" href="{{.Hermes.Product.Link}}" target="_blank">
                                    {{ if .Hermes.Product.Logo }}
                                        <img src="{{.Hermes.Product.Logo | url }}" class="email-logo" />
                                    {{ else }}
                                        {{ .Hermes.Product.Name }}
                                    {{ end }}
                                </a>
                            </td>
                        </tr>

                        <!-- Email Body -->
                        <tr>
                            <td class="email-body" width="100%">
                                <table class="email-body_inner" align="center" width="570" cellpadding="0" cellspacing="0">
                                    <!-- Body content -->
                                    <tr>
                                        <td class="content-cell">
                                            <h1>
                                                {{if .Email.Body.Title }}
                                                    {{ .Email.Body.Title }}
                                                {{ else }}
                                                    {{.Email.Body.Greeting }} {{ .Email.Body.Name }},
                                                {{ end }}
                                            </h1>
                                            {{ if (ne .Email.Body.IntrosMarkdown "") }}
                                                {{ .Email.Body.IntrosMarkdown.ToHTML }}
                                            {{ else if gt (len .Email.Body.IntrosUnsafe) 0 }}
                                                {{ with .Email.Body.IntrosUnsafe }}
                                                    {{ range $line := . }}
                                                        <p>{{ $line }}</p>
                                                    {{ end }}
                                                {{ end }}
                                            {{ else }}
                                                {{ with .Email.Body.Intros }}
                                                    {{ if gt (len .) 0 }}
                                                        {{ range $line := . }}
                                                            <p>{{ $line }}</p>
                                                        {{ end }}
                                                    {{ end }}
                                                {{ end }}
                                            {{ end }}
                                            
                                            {{ if (ne .Email.Body.FreeMarkdown "") }}
                                                {{ .Email.Body.FreeMarkdown.ToHTML }}
                                            {{ else }}

                                                {{ with .Email.Body.Dictionary }}
                                                    {{ if gt (len .) 0 }}
                                                        <dl class="body-dictionary">
                                                            {{ range $entry := . }}
                                                                <div>
                                                                    <dt>{{ $entry.Key }}:</dt>
                                                                    <dd>
                                                                        {{ if gt (len $entry.Value) 0 }}
                                                                            {{ $entry.Value }}
                                                                        {{ else if gt (len $entry.UnsafeValue) 0 }}
                                                                            {{ $entry.UnsafeValue }}
                                                                        {{ else }}
                                                                            No Value Set
                                                                        {{ end }}
                                                                    </dd>
                                                                </div>
                                                            {{ end }}
                                                        </dl>
                                                    {{ end }}
                                                {{ end }}

                                            <!-- Table -->
                                            {{ with .Email.Body.Tables }}
                                                {{ if gt (len .) 0 }}
                                                    {{ range $table := . }}
                                                        {{ $data := .Data }}
                                                        {{ if eq (len $data) 0 }}
                                                            {{ $data = .Table.Data }}
                                                        {{ end }}
                                                        {{ $columns := .Columns }}
                                                        {{ if gt (len $data) 0 }}
                                                            {{ if $table.TitleUnsafe }}
                                                                <div class="data-table-title-unsafe">{{$table.TitleUnsafe}}</div>
                                                            {{ else if $table.Title }}
                                                                <div class="data-table-title">{{$table.Title}}</div>
                                                            {{ end }}
                                                            <table class="data-wrapper{{ with $table.Class }} {{ . }}{{ end }}" width="100%" cellpadding="0" cellspacing="0">
                                                                <tr>
                                                                    <td colspan="2">
                                                                        <table class="data-table" width="100%" cellpadding="0" cellspacing="0">
                                                                            <tr>
                                                                                {{ $col := index $data 0 }}
                                                                                {{ range $entry := $col }}
                                                                                <th {{ with $columns }} {{ $width :=index .CustomWidth $entry.Key }} {{ with $width }}
                                                                                    width="{{ . }}" {{ end }} {{ $align :=index .CustomAlignment $entry.Key }} {{ with $align }}
                                                                                    class="align-{{ . }}" {{ end }} {{ end }}>
                                                                                    <p>{{ $entry.Key }}</p>
                                                                                </th>
                                                                                {{ end }}
                                                                            </tr>
                                                                            {{ range $row := $data }}
                                                                            <tr>
                                                                                {{ range $cell := $row }}
                                                                                <td {{ with $columns }} {{ $align :=index .CustomAlignment $cell.Key }} {{ with $align }}
                                                                                    class="align-{{ . }}" {{ end }} {{ end }}>
                                                                                    {{ if gt (len $cell.Value) 0 }}
                                                                                        {{ $cell.Value }}
                                                                                    {{ else if gt (len $cell.UnsafeValue) 0 }}
                                                                                        {{ $cell.UnsafeValue }}
                                                                                    {{ else }}
                                                                                        No Value Set
                                                                                    {{ end }}
                                                                                </td>
                                                                                {{ end }}
                                                                            </tr>
                                                                            {{ end }}
                                                                        </table>
                                                                    </td>
                                                                </tr>
                                                            </table>
                                                            {{ if $table.FooterUnsafe }}
                                                                <div class="table-footer">{{$table.FooterUnsafe}}</div>
                                                            {{ else if $table.Footer }}
                                                                <div class="table-footer">{{$table.Footer}}</div>
                                                            {{ end }}
                                                        {{ end }}
                                                    {{ end }}
                                                {{ end }}
                                            {{ end }}

                                            <!-- Action -->
                                            {{ with .Email.Body.Actions }}
                                                {{ if gt (len .) 0 }}
                                                    {{/* Establish theme-based defaults for VML button */}}
                                                    {{ $themeName := $.Hermes.Theme.Name }}
                                                    {{ $defaultColor := "#3869D4" }}
                                                    {{ if eq $themeName "flat" }}{{ $defaultColor = "#00948D" }}{{ end }}
                                                    {{ $arcsize := "10%" }}
                                                    {{ if eq $themeName "flat" }}{{ $arcsize = "0%" }}{{ end }}
                                                    {{ range $action := . }}
                                                        <p>{{ $action.Instructions }}</p>
                                                        {{ $length := len $action.Button.Text }}
                                                        {{ $width := add (mul $length 9) 20 }}
                                                        {{if (lt $width 200)}}
                                                            {{$width = 200}}
                                                        {{else if (gt $width 570)}}
                                                            {{$width = 570}}
                                                        {{end}}
                                                        {{safe "<!--[if mso]>" }}
                                                            {{ if $action.Button.Text }}
                                                                <div class="vml-button-wrapper">
                                                                    <v:roundrect xmlns:v="urn:schemas-microsoft-com:vml" xmlns:w="urn:schemas-microsoft-com:office:word" href="{{ $action.Button.Link }}" style="height:45px;v-text-anchor:middle;width:{{$width}}px;background-color:{{ if $action.Button.Color }}{{ $action.Button.Color }}{{ else }}{{$defaultColor}}{{ end }};" arcsize="{{$arcsize}}" {{ if $action.Button.Color }}strokecolor="{{ $action.Button.Color }}" fillcolor="{{ $action.Button.Color }}"{{ else }}strokecolor="{{$defaultColor}}" fillcolor="{{$defaultColor}}"{{ end }}>
                                                                        <w:anchorlock/>
                                                                        <center style="color: {{ if $action.Button.TextColor }}{{ $action.Button.TextColor }}{{else}}#FFFFFF{{ end }};font-size: 15px;text-align: center;font-family:sans-serif;font-weight:bold;">
                                                                            {{ $action.Button.Text }}
                                                                        </center>
                                                                    </v:roundrect>
                                                                </div>
                                                            {{ end }}
                                                            {{ if $action.InviteCode }}
                                                                <div class="invite-code-container">
                                                                    <table class="body-action" align="center" width="100%" cellpadding="0" cellspacing="0">
                                                                        <tr>
                                                                            <td align="center">
                                                                                <table class="invite-code-table" align="center" cellpadding="0" cellspacing="0">
                                                                                <tr>
                                                                                    <td class="invite-code-cell">
                                                                                    {{ $action.InviteCode }}
                                                                                    </td>
                                                                                </tr>
                                                                                </table>
                                                                            </td>
                                                                        </tr>
                                                                    </table>
                                                                </div>
                                                            {{ end }}   
                                                        {{safe "<![endif]-->" }}
                                                            {{safe "<!--[if !mso]><!-- -->"}}
                                                                <table class="body-action" align="center" width="100%" cellpadding="0"
                                                                    cellspacing="0">
                                                                    <tr>
                                                                        <td align="center">
                                                                            <div>
                                                                                {{ if $action.Button.Text }}
                                                                                    <a href="{{ $action.Button.Link }}" class="button"
                                                                                        style="{{ with $action.Button.Color }}background-color: {{ . }};{{ end }} {{ with $action.Button.TextColor }}color: {{ . }};{{ end }} width: {{$width}}px;"
                                                                                        target="_blank">
                                                                                        {{ $action.Button.Text }}
                                                                                    </a>
                                                                                {{end}}
                                                                                {{ if $action.InviteCode }}
                                                                                    <span class="invite-code">{{ $action.InviteCode }}</span>
                                                                                {{end}}
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                </table>
                                                            {{safe "<![endif]-->" }}
                                                        {{ end }}
                                                    {{ end }}
                                                {{ end }}

                                            {{ end }}

                                            {{ if (ne .Email.Body.OutrosMarkdown "") }}
                                                {{ .Email.Body.OutrosMarkdown.ToHTML }}
                                            {{ else if gt (len .Email.Body.OutrosUnsafe) 0 }}
                                                {{ with .Email.Body.OutrosUnsafe }}
                                                    {{ range $line := . }}
                                                        <p>{{ $line }}</p>
                                                    {{ end }}
                                                {{ end }}
                                            {{ else }}
                                                {{ with .Email.Body.Outros }} 
                                                    {{ if gt (len .) 0 }}
                                                        {{ range $line := . }}
                                                            <p>{{ $line }}</p>
                                                        {{ end }}
                                                    {{ end }}
                                                {{ end }}
                                            {{ end }}

                                            {{ with .Email.Body.Signature }} 
                                                {{ if (gt (len .) 0) }}
                                                    <b>
                                                        <p style="margin-top: 15px;">{{ . }}</p>
                                                    </b>
                                                {{ end }}
                                            {{ end }}

                                            {{ if (eq .Email.Body.FreeMarkdown "") }}
                                                {{ with .Email.Body.Actions }} 
                                                    <table class="body-sub">
                                                        <tbody>
                                                            {{ range $action := . }}
                                                                {{if $action.Button.Text}}
                                                                    <tr>
                                                                        <td>
                                                                            <p class="sub">{{$.Hermes.Product.TroubleText | replace "{ACTION}" $action.Button.Text}}</p>
                                                                            <p class="sub"><a href="{{ $action.Button.Link }}">{{ $action.Button.Link }}</a></p>
                                                                        </td>
                                                                    </tr>
                                                                {{ end }}
                                                            {{ end }}
                                                        </tbody>
                                                    </table>
                                                {{ end }}
                                            {{ end }}
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <table class="email-footer" align="center" width="570" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td class="content-cell">
                                            <p class="sub center">
                                                {{.Hermes.Product.Copyright}}  - Delivered by <a id="mail-footer-link" target="_blank" href="{{.Hermes.Product.Link}}">{{ .Hermes.Product.Name }}</a>
                                            </p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </body>
</html>
